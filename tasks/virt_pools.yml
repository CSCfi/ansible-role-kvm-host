# Gather facts about storage pools
# Facts will be available as 'ansible_libvirt_pools'
- name: Check current pools
  virt_pool:
    command: facts

- name: Define a new storage pool
  become: true
  virt_pool:
    command: define
    name: "{{ item }}"
    xml: '{{ lookup("template", "libvirt_pool.xml") }}'
  loop: "{{ libvirt_storage_pools }}"

- name: Build a storage pool if it does not exist
  become: true
  virt_pool:
    command: build
    name: "{{ item }}"
  loop: "{{ libvirt_storage_pools }}"
  when: 'ansible_libvirt_pools[item]["state"] | default("new") != "active"'

- name: Start a storage pool
  virt_pool:
    state: active
    name: "{{ item }}"
  loop: "{{ libvirt_storage_pools }}"
  when: 'ansible_libvirt_pools[item]["state"] | default("new") != "active"'

- name: Ensure that pools will be started at boot
  virt_pool:
    autostart: true
    name: "{{ item }}"
  loop: "{{ libvirt_storage_pools }}"

